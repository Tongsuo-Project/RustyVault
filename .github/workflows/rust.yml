name: Rust

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  macos-test:
    strategy:
      matrix:
        os:
          - macos-latest
    runs-on: ${{matrix.os}}
    steps:
    - uses: actions/checkout@v3
    - name: Build
      run: cargo build --verbose
    - name: Run tests
      run: cargo test --verbose
      
  linux-test:
    strategy:
      matrix:
        os:
          - ubuntu-latest
    runs-on: ${{matrix.os}}

    steps:
    - uses: actions/checkout@v3
    - run: cat > my.cnf <<EOF
            [mysqld]
            skip-ssl
            EOF
    - run: docker run -- name mysql57 -e MYSQL_ROOT_PASSWORD=my-secret-pw -v ./my.cnf:/etc/mysql/conf.d/my.cnf -d mysql:5.7
    - name: Build
      run: cargo build --verbose
    - name: Run tests
      run: cargo test --verbose
    - run: docker stop mysql57
    - run: docker rm mysql57
  windows-test:
    strategy:
      matrix:
        os:
          - windows-latest
    runs-on: ${{matrix.os}}

    steps:
    - uses: actions/checkout@v3
    - run: echo "VCPKG_ROOT=$env:VCPKG_INSTALLATION_ROOT" | Out-File -FilePath $env:GITHUB_ENV -Append
    - run: vcpkg install openssl:x64-windows-static-md
    - run: setx MYSQLCLIENT_LIB_DIR "./src/storage/mysql/mysqlclient.lib"
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
    - name: Start MySQL
      uses: samin/mysql-action@v1.3
      with:
        # The port of host
        host port: 3306
        # The port of container
        container port: 3306
        # --character-set-server - The character set of MySQL server
        character set server: utf8mb4
        # --collation-server - The character collation of MySQL server
        collation server: utf8mb4_general_ci
        # Version of MySQL to use
        mysql version: 5.7
        # MYSQL_ROOT_PASSWORD - root superuser password
        mysql root password: password
        # MYSQL_DATABASE - name for the default database that is created
        mysql database: vault
        # MYSQL_USER - create the specified user with superuser power for created database
        mysql user: vault
        # MYSQL_PASSWORD - specified superuser password which user is power for created database
        mysql password: password
    - name: Build
      run: cargo build --verbose
    - name: Run tests
      run: cargo test --verbose
